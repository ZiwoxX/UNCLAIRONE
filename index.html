<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta id="viewportMeta" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" /> 
  <title>10 C.1 GANK - Detail Siswa & Stories</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>
  
 <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a0b2e 0%, #0f1419 100%);
      min-height: 100vh;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px; 
      overflow-x: hidden; 
    }

    /* --- CUSTOM SCROLLBAR (NEON) --- */
    ::-webkit-scrollbar { width: 12px; height: 12px; }
    ::-webkit-scrollbar-track { background: #0f1419; border-left: 1px solid #2a1b3d; }
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #7e62ff, #ff775c);
        border-radius: 6px;
        border: 3px solid #0f1419; 
    }
    ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #6a44d8, #e05d47); }
    * { scrollbar-width: thin; scrollbar-color: #7e62ff #0f1419; }

    /* --- NAVIGASI --- */
    .nav-link-left { 
        position: absolute; top: 20px; left: 20px; color: #bdb6f0; text-decoration: none;
        font-weight: 600; font-size: 1rem; padding: 5px 10px; border-radius: 8px;
        background: rgba(106, 68, 216, 0.2); transition: background 0.3s, color 0.3s; z-index: 2; 
    }
    .nav-link-left:hover { background: #6a44d8; color: #ffffff; }
    
    .nav-link-right {
        position: absolute; top: 20px; right: 20px; color: #bdb6f0; text-decoration: none;
        font-weight: 600; font-size: 1rem; padding: 5px 10px; border-radius: 8px;
        background: rgba(106, 68, 216, 0.2); transition: background 0.3s, color 0.3s; z-index: 2;
    }
    .nav-link-right:hover { background: #6a44d8; color: #ffffff; }

    h1 {
      margin-bottom: 20px; font-weight: 700; font-size: 2.5rem; letter-spacing: 1.5px;
      color: #ffffff; text-shadow: 0 0 10px #6a44d8; margin-top: 40px; text-align: center;
    }

    /* ========================================= */
    /* --- STYLE STORY KELAS (IG STYLE) --- */
    /* ========================================= */
    .stories-container {
        width: 100%; max-width: 800px; margin: 0 auto 25px auto; overflow-x: auto;
        white-space: nowrap; padding: 10px 5px; display: flex; gap: 15px;
        scrollbar-width: none; border-bottom: 1px solid rgba(126, 98, 255, 0.2);
        justify-content: flex-start;
        min-height: 90px;
    }
    .stories-container::-webkit-scrollbar { display: none; }

    .story-item {
        display: inline-flex; flex-direction: column; align-items: center;
        cursor: pointer; width: 75px; transition: transform 0.2s; flex-shrink: 0;
    }
    .story-item:hover { transform: scale(1.05); }

    .story-ring {
        width: 64px; height: 64px; border-radius: 50%; padding: 3px;
        background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        position: relative; display: flex; align-items: center; justify-content: center;
    }
    
    .story-photo {
        width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        border: 3px solid #1a0b2e; background: #fff;
    }

    .story-name {
        font-size: 0.75rem; margin-top: 5px; color: #e0e0e0;
        max-width: 70px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;
    }

    /* --- STORY VIEWER (FULLSCREEN OVERLAY) --- */
    .story-viewer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 2000; display: none; flex-direction: column;
    }

    .story-progress-bar {
        display: flex; gap: 5px; padding: 10px; position: absolute;
        top: 0; left: 0; right: 0; z-index: 2002;
    }
    
    .progress-segment {
        flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;
    }
    
    .progress-fill { height: 100%; background: #fff; width: 0%; }

    .story-header {
        position: absolute; top: 25px; left: 15px; z-index: 2002;
        display: flex; align-items: center; gap: 10px;
    }
    .story-header img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #fff; }
    .story-header span { color: #fff; font-weight: bold; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
    .story-date { font-size: 0.8rem; opacity: 0.8; font-weight: normal; margin-left: 5px;}

    .story-content-area {
        flex: 1; display: flex; align-items: center; justify-content: center;
        position: relative; background: #111; width: 100%; height: 100%;
    }

    .story-image-display { 
        max-width: 100%; max-height: 100vh; object-fit: contain; width: auto; height: auto;
    }

    .story-text-display {
        font-size: 1.5rem; color: #fff; text-align: center; padding: 20px;
        font-weight: 600; line-height: 1.5;
        background: linear-gradient(45deg, #7e62ff, #ff775c);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5); width: 90%;
    }
    
    .story-close-btn {
        position: absolute; top: 20px; right: 20px; color: #fff; font-size: 2.5rem;
        cursor: pointer; z-index: 2005; opacity: 0.7;
    }

    /* ========================================= */
    /* --- IG STYLE UPLOAD OVERLAY (NEW) --- */
    /* ========================================= */
    #igUploadOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: none; flex-direction: column;
        font-family: 'Inter', sans-serif;
    }

    .ig-top-bar {
        padding: 15px; display: flex; justify-content: space-between; align-items: center;
        position: absolute; top: 0; left: 0; right: 0; z-index: 10;
        background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    }

    .ig-user-pill {
        background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
        padding: 5px 15px 5px 5px; border-radius: 30px; display: flex; align-items: center;
        cursor: pointer; border: 1px solid rgba(255,255,255,0.3);
    }

    .ig-user-thumb {
        width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid #fff;
    }

    .ig-user-name { font-weight: 600; font-size: 0.9rem; color: #fff; max-width: 150px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    .ig-close { font-size: 2rem; color: #fff; cursor: pointer; padding: 0 10px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }

    /* Preview Area */
    .ig-preview-stage {
        flex: 1; position: relative; display: flex; align-items: center; justify-content: center;
        background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045); /* Default Text BG */
        overflow: hidden;
    }

    .ig-media-preview {
        width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; display: none;
        background: #000;
    }

    .ig-caption-input {
        position: absolute; z-index: 5; background: transparent; border: none;
        color: #fff; font-size: 1.5rem; text-align: center; width: 80%;
        font-family: 'Inter', sans-serif; font-weight: 600;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8); resize: none; outline: none;
        overflow: hidden;
    }
    .ig-caption-input::placeholder { color: rgba(255,255,255,0.7); }

    /* Bottom Controls */
    .ig-bottom-bar {
        padding: 20px; display: flex; justify-content: space-between; align-items: center;
        background: #000;
    }

    .ig-mode-switch {
        display: flex; gap: 20px; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;
    }
    .ig-mode-item { cursor: pointer; padding: 5px; transition: 0.3s; }
    .ig-mode-item.active { color: #fff; border-bottom: 2px solid #fff; }

    .ig-send-btn {
        background: #fff; color: #000; border: none; padding: 10px 25px;
        border-radius: 30px; font-weight: 700; cursor: pointer; font-size: 1rem;
        display: flex; align-items: center; gap: 5px;
    }
    .ig-send-btn:disabled { opacity: 0.5; }

    /* User Selection Modal List */
    .ig-user-list-modal {
        position: absolute; top: 60px; left: 15px; background: #1a1a2e;
        border: 1px solid #4a3c7a; border-radius: 15px; width: 250px; max-height: 300px;
        overflow-y: auto; z-index: 20; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .ig-user-option {
        padding: 10px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .ig-user-option:hover { background: rgba(126, 98, 255, 0.2); }
    .ig-user-option img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
    .ig-user-option span { color: #e0e0e0; font-size: 0.9rem; }

    /* --- QUOTE & MAIN CONTENT --- */
    .quote-box {
        background: rgba(255, 255, 255, 0.05); border-left: 5px solid #ff775c; 
        border-radius: 15px; padding: 20px 30px; margin: 0 auto 25px auto; 
        max-width: 800px; width: 90%; text-align: center; position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px);
        transition: transform 0.3s;
    }
    .quote-box:hover { transform: scale(1.02); background: rgba(255, 255, 255, 0.08); }
    .quote-icon { font-size: 1.5rem; color: #ff775c; margin-bottom: 10px; opacity: 0.8; }
    .quote-text { font-size: 1.1rem; font-style: italic; line-height: 1.6; margin: 0; color: #e0e0e0; font-weight: 300; }
    .quote-author { margin-top: 10px; font-weight: 700; color: #bdb6f0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

    /* --- RUNNING QUOTES --- */
    .running-quotes-wrapper {
        width: 100%; overflow-x: auto; margin-bottom: 40px; padding: 20px 0;
        position: relative; background: linear-gradient(to right, rgba(106, 68, 216, 0.05), rgba(0, 0, 0, 0.2), rgba(106, 68, 216, 0.05));
        border-top: 1px solid rgba(106, 68, 216, 0.4); border-bottom: 1px solid rgba(106, 68, 216, 0.4);
        box-shadow: inset 0 0 10px rgba(0,0,0,0.4); cursor: grab; 
        -ms-overflow-style: none; scrollbar-width: none;  
    }
    .running-quotes-wrapper::-webkit-scrollbar { display: none; }
    .running-track { display: flex; width: max-content; padding-left: 20px; white-space: nowrap; }
    
    .student-quote-card {
        background: linear-gradient(145deg, #2a1b3d, #151525); border-left: 3px solid #7e62ff;
        border-radius: 10px; padding: 15px 20px; margin: 0 15px; min-width: 240px; max-width: 350px;
        display: flex; flex-direction: column; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: all 0.3s ease; cursor: pointer; user-select: none; min-height: 120px; height: auto; box-sizing: border-box; 
    }
    .running-quotes-wrapper.active-drag { cursor: grabbing; }
    .student-quote-card:hover {
        transform: scale(1.05) translateY(-5px); background: linear-gradient(145deg, #35224d, #1d1d33);
        border-left-color: #ff775c; box-shadow: 0 10px 25px rgba(0,0,0,0.5), 0 0 15px rgba(255, 119, 92, 0.4); z-index: 2;
    }
    .student-quote-card:active { transform: scale(0.95); }
    .sq-text {
        font-style: italic; font-size: 0.95rem; color: #e0e0e0; margin-bottom: 10px; line-height: 1.5;
        pointer-events: none; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 4; overflow: hidden; text-overflow: ellipsis; 
    }
    .sq-author {
        font-weight: 600; font-size: 0.85rem; color: #bdb6f0; display: flex; align-items: center; justify-content: flex-end; pointer-events: none;
    }
    .sq-author img {
        width: 28px; height: 28px; border-radius: 50%; object-fit: cover; margin-right: 10px;
        border: 2px solid #7e62ff; box-shadow: 0 0 5px rgba(106, 68, 216, 0.5);
    }
    .student-quote-card:hover .sq-author img { border-color: #ff775c; }

    /* --- STATISTIK KELAS --- */
    .stats-container { display: flex; justify-content: center; gap: 20px; margin: 0 auto 30px auto; width: 90%; max-width: 800px; }
    .stat-box {
        background: rgba(126, 98, 255, 0.1); border: 1px solid #7e62ff; border-radius: 10px; padding: 15px; text-align: center;
        flex: 1; min-width: 150px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.3s;
    }
    .stat-box:hover { transform: translateY(-5px); background: rgba(126, 98, 255, 0.2); }
    .stat-box i { font-size: 1.5rem; color: #ff775c; margin-bottom: 5px; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #ffffff; display: block; }
    .stat-label { font-size: 0.8rem; color: #bdb6f0; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* --- PENCARIAN --- */
    .filter-controls { display: flex; justify-content: center; width: 100%; max-width: 500px; margin: 0 auto 30px auto; }
    .search-container {
        width: 100%; position: relative; border-radius: 8px; background: #1a1a2e; 
        box-shadow: 0 0 15px rgba(255, 119, 92, 0.4); border: 1px solid #ff775c; display: flex; align-items: stretch; padding: 0;
    }
    #searchInput {
        flex-grow: 1; width: 100%; padding: 12px 15px; border-radius: 8px 0 0 8px; border: none; 
        background: transparent; color: #e0e0e0; font-size: 1rem; transition: background 0.3s;
    }
    #searchInput:focus { outline: none; background: rgba(42, 27, 61, 0.5); }
    .search-button-area {
        padding: 12px 15px; background: #ff775c; border-radius: 0 8px 8px 0; cursor: pointer;
        transition: background 0.3s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
    }
    .search-button-area:hover { background: #e05d47; }
    .search-button-area .fa-search { color: #1a1a2e; font-size: 1.1rem; position: static; transform: none; }
    
    /* --- CARD GRID --- */
    .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; width: 100%; max-width: 1300px; }
    .card {
      background: linear-gradient(145deg, #2a1b3d, #1a1a2e); border-radius: 25px;
      box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.5), -8px -8px 20px rgba(106, 68, 216, 0.1);
      overflow: hidden; color: #e0e0e0; transition: transform 0.4s ease, box-shadow 0.4s ease;
      display: flex; flex-direction: column; align-items: center; padding: 25px; border: 1px solid #4a3c7a;
      cursor: pointer; opacity: 0; transform: translateY(20px); animation-fill-mode: forwards; position: relative; 
      transform-style: preserve-3d;
    }
    .card:hover { box-shadow: 15px 15px 40px rgba(0,0,0,0.8), -15px -15px 40px rgba(106, 68, 216, 0.3); }
    .card.animate { animation-name: fadeSlideUp; animation-duration: 0.6s; animation-timing-function: ease-out; }
    .card-like-badge {
        position: absolute; top: 15px; right: 15px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
        color: #ff775c; padding: 5px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;
        border: 1px solid rgba(255, 119, 92, 0.5); display: flex; align-items: center; gap: 6px; z-index: 5; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.5); transform: translateZ(20px); 
    }
    .card-like-badge i { font-size: 1rem; }
    @keyframes fadeSlideUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }

    .photo {
      width: 130px; height: 130px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 25px #6a44d8;
      border: 4px solid #7e62ff; margin-bottom: 20px; background-color: #3d2c66; transform: translateZ(30px);
    }
    .name { font-weight: 700; font-size: 1.3rem; margin-bottom: 10px; text-align: center; color: #ffffff; transform: translateZ(20px); }
    .info { font-size: 0.95rem; line-height: 1.4; text-align: center; margin-bottom: 5px; transform: translateZ(10px); }
    .label { font-weight: 600; color: #bdb6f0; }
    .ig-label { display: block; text-align: center; margin-bottom: 2px; }
    .description { 
        font-size: 0.85rem; line-height: 1.3; text-align: center; margin-top: 10px; padding: 5px 0 10px 0; 
        border-top: 1px solid rgba(189, 182, 240, 0.2); color: #bdb6f0; font-style: italic; transform: translateZ(10px);
    }
    .instagram-link {
      color: #bdb6f0; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; 
    }
    .instagram-link::before { content: '\f16d'; font-family: 'Font Awesome 6 Brands'; margin-right: 6px; color: #7e62ff; }
    .instagram-link:hover { color: #7e62ff; text-decoration: underline; }

    /* --- MODAL --- */
    .modal {
      position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); animation: fadeIn 0.3s;
      display: none; justify-content: center; align-items: center; overflow-y: auto; padding: 0; 
    }
    .modal-content {
      background: linear-gradient(160deg, #2a1b3d 5%, #151525 100%); padding: 30px; border-radius: 25px;
      box-shadow: 0 0 50px rgba(106, 68, 216, 0.8); width: 90%; max-width: 800px; position: relative;
      color: #e0e0e0; animation: slideIn 0.4s ease-out; border: 2px solid #6a44d8; max-height: 95vh; overflow-y: auto; margin: auto; 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close-btn {
      color: #bbb; position: absolute; top: 15px; right: 25px; font-size: 35px; font-weight: bold;
      transition: color 0.3s; cursor: pointer; z-index: 10; 
    }
    .close-btn:hover { color: #7e62ff; }
    .modal-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #4a3c7a; padding-bottom: 10px; }
    .modal-photo {
      width: 150px; height: 150px; border-radius: 50%; object-fit: cover;
      border: 5px solid #7e62ff; box-shadow: 0 0 30px rgba(106, 68, 216, 0.5); margin-bottom: 15px;
    }
    .modal-name { font-size: 2rem; font-weight: 700; color: #ffffff; }
    .modal-details {
      display: flex; flex-direction: column; gap: 10px; margin-top: 20px;
      padding: 10px; border-radius: 10px; background: #1a1a2e; border-left: 5px solid #6a44d8;
    }
    .modal-details p { margin: 0; line-height: 1.6; }
    .modal-details .label { color: #7e62ff; font-weight: 700; width: 100px; display: inline-block; }

    /* --- INTERACTION (LIKE COMMENT) --- */
    .interaction-section { margin-top: 20px; border-top: 1px solid #4a3c7a; padding-top: 20px; }
    .like-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 1.2rem; color: #bdb6f0; }
    .like-btn {
        background: rgba(255, 255, 255, 0.1); border: 2px solid #ff775c; color: #ff775c; border-radius: 50%;
        width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease;
        display: flex; align-items: center; justify-content: center;
    }
    .like-btn:hover { background: #ff775c; color: white; transform: scale(1.1); }
    .like-btn.liked { background: #ff775c; color: white; box-shadow: 0 0 15px rgba(255, 119, 92, 0.6); }
    .comments-wrapper h4 { color: #bdb6f0; margin-bottom: 15px; border-left: 3px solid #7e62ff; padding-left: 10px; }
    .comments-list {
        max-height: 200px; overflow-y: auto; background: rgba(0, 0, 0, 0.2); border-radius: 10px;
        padding: 10px; margin-bottom: 15px; border: 1px solid #4a3c7a;
    }
    .comment-item { background: #1a1a2e; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; border-left: 2px solid #7e62ff; }
    .comment-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: #bdb6f0; margin-bottom: 4px; font-weight: bold; }
    .comment-text { color: #e0e0e0; word-wrap: break-word; }
    .no-comments { text-align: center; color: #666; font-style: italic; padding: 20px; }
    .comment-form { display: flex; gap: 10px; }
    .comment-form input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #4a3c7a; background: #151525; color: white; outline: none; }
    .comment-form input:focus { border-color: #7e62ff; }
    .send-comment-btn { background: #7e62ff; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
    .send-comment-btn:hover { background: #6a44d8; transform: scale(1.1); }

    /* --- GALLERY & LIGHTBOX --- */
    .photo-gallery { margin-top: 30px; }
    .photo-gallery h3 { color: #bdb6f0; border-bottom: 1px solid #4a3c7a; padding-bottom: 5px; margin-bottom: 15px; font-weight: 600; }
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .gallery-img { width: 100%; height: 100px; object-fit: cover; border-radius: 10px; transition: transform 0.3s ease; border: 2px solid #4a3c7a; cursor: pointer; }
    .gallery-img:hover { transform: scale(1.05); border-color: #7e62ff; }
    .lightbox {
      display: none; position: fixed; z-index: 200; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.9);
      animation: fadeIn 0.3s; justify-content: center; align-items: center; 
    }
    .lightbox-content {
      width: auto; height: auto; max-width: 90%; max-height: 90vh; 
      display: block; border-radius: 10px; box-shadow: 0 0 20px rgba(106, 68, 216, 0.5);
      animation: zoomIn 0.4s; margin: auto; transition: opacity 0.15s ease-in-out; 
    }
    @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .lightbox-close-btn { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
    .lightbox-nav-btn {
        cursor: pointer; position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -22px;
        color: white; font-weight: bold; font-size: 25px; transition: 0.6s ease; border-radius: 0 3px 3px 0;
        user-select: none; background-color: rgba(0, 0, 0, 0.5); opacity: 0.8; z-index: 201; 
    }
    .lightbox-nav-btn.prev { left: 0; border-radius: 0 4px 4px 0; }
    .lightbox-nav-btn.next { right: 0; border-radius: 4px 0 0 4px; }
    .lightbox-nav-btn:hover { background-color: rgba(0, 0, 0, 0.8); opacity: 1; }

    /* --- SPOTIFY & MENFESS BUTTONS (UPDATED POSITION) --- */
    #toggleButton {
        position: fixed; bottom: 20px; left: 20px; /* Kiri Bawah */
        width: 50px; height: 50px; border-radius: 50%;
        background-color: #1DB954; color: white; border: none; cursor: pointer; font-size: 20px;
        display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(29, 185, 84, 0.6);
        z-index: 12; transition: background-color 0.3s, transform 0.3s;
    }
    #toggleButton:hover { background-color: #1ed760; transform: scale(1.05); }

    #spotifyPlayerContainer {
        position: fixed; left: 20px; bottom: 20px; /* Kiri Bawah */
        z-index: 11; box-shadow: none; border-radius: 12px;
        overflow: visible; transition: transform 0.4s ease-out; transform: translateY(100px); 
    }
    #spotifyPlayerContainer.open { transform: translateY(-90px); }
    
    #menfessButton {
        position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%;
        background-color: #ff775c; color: white; border: none; cursor: pointer; font-size: 20px;
        display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 119, 92, 0.6);
        z-index: 12; transition: background-color 0.3s, transform 0.3s;
    }
    #menfessButton:hover { background-color: #e05d47; transform: scale(1.05); }

    /* --- TOMBOL ADD STORY BARU (FLOATING) --- */
    #addStoryButton {
        position: fixed; 
        bottom: 140px; /* Posisi di atas tombol Menfess */
        right: 20px; 
        width: 50px; 
        height: 50px; 
        border-radius: 50%;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        color: white; 
        border: 2px solid #fff; 
        cursor: pointer; 
        font-size: 20px;
        display: flex; align-items: center; justify-content: center; 
        box-shadow: 0 4px 15px rgba(200, 35, 100, 0.5);
        z-index: 99; 
        transition: transform 0.3s, box-shadow 0.3s;
    }
    #addStoryButton:hover { 
        transform: scale(1.1) rotate(10deg); 
        box-shadow: 0 0 25px rgba(200, 35, 100, 0.8);
    }

    /* --- OTHER MODALS --- */
    .quote-modal-content {
        text-align: center; border: 3px solid #ff775c; max-width: 500px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; padding: 40px 25px;
    }
    .quote-modal-icon { font-size: 3rem; color: #ff775c; margin-bottom: 20px; }
    .quote-modal-text { font-size: 1.4rem; font-style: italic; line-height: 1.5; margin-bottom: 25px; color: #ffffff; }
    .quote-modal-author { display: flex; align-items: center; justify-content: center; background: rgba(126, 98, 255, 0.1); padding: 10px 20px; border-radius: 50px; border: 1px solid #7e62ff; }
    .quote-modal-author img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #ffffff; }
    
    .menfess-modal-content { max-width: 600px; padding: 25px; border: 3px solid #ff775c; animation: slideIn 0.4s ease-out; }
    .menfess-form h3 { color: #ff775c; margin-top: 0; border-bottom: 1px solid rgba(255, 119, 92, 0.3); padding-bottom: 10px; }
    .menfess-form label { display: block; margin-top: 15px; margin-bottom: 5px; color: #bdb6f0; font-weight: 600; }
    .menfess-form input[type="text"], .menfess-form textarea {
        width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #4a3c7a;
        background: #1a1a2e; color: #e0e0e0; font-size: 1rem; transition: border-color 0.3s;
    }
    .menfess-form input[type="text"]:focus, .menfess-form textarea:focus { outline: none; border-color: #ff775c; }
    .menfess-form textarea { resize: vertical; min-height: 120px; }
    .menfess-submit-btn {
        display: block; width: 100%; padding: 12px; margin-top: 20px; background-color: #7e62ff; color: white;
        border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.1s;
    }
    .menfess-submit-btn:hover { background-color: #6a44d8; }
    #menfessSection { width: 100%; max-width: 1300px; margin: 40px auto 60px auto; padding-top: 20px; border-top: 2px dashed rgba(126, 98, 255, 0.4); }
    #menfessSection h2 { text-align: center; color: #ff775c; font-size: 2rem; margin-bottom: 30px; }
    .menfess-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 0 10px; }
    .menfess-card {
        background: linear-gradient(145deg, #35224d, #1d1d33); border-radius: 15px; padding: 20px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.5); border: 1px solid #7e62ff; display: flex; flex-direction: column; transition: transform 0.3s;
    }
    .menfess-card:hover { transform: translateY(-3px) scale(1.01); box-shadow: 0 10px 25px rgba(0,0,0,0.7); }
    .menfess-to { font-weight: 700; color: #ff775c; font-size: 1.1rem; margin-bottom: 10px; border-bottom: 1px dashed rgba(255, 119, 92, 0.5); padding-bottom: 5px; }
    .menfess-content { font-style: italic; color: #e0e0e0; line-height: 1.5; flex-grow: 1; margin-bottom: 15px; }
    .menfess-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #bdb6f0; margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(189, 182, 240, 0.2); }

    /* --- MOBILE OPTIMIZATION --- */
    @media (max-width: 600px) {
      body { padding: 0; padding-top: 50px; padding-bottom: 20px; align-items: center; }
      .card { padding: 20px; }
      .photo { width: 110px; height: 110px; }
      h1 { font-size: 2rem; margin-top: 20px; }
      .nav-link-left { top: 10px; left: 10px; font-size: 0.9rem; padding: 3px 8px; }
      .nav-link-right { top: 10px; right: 10px; font-size: 0.9rem; padding: 3px 8px; max-width: 50%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .quote-box { width: 95%; margin: 15px auto 15px auto; box-sizing: border-box; }
      .stats-container { flex-direction: column; gap: 15px; width: 95%; margin: 0 auto 30px auto; box-sizing: border-box; }
      .filter-controls { padding: 0; max-width: 100%; width: 95%; margin: 0 auto 30px auto; box-sizing: border-box; }
      .search-container { width: 100%; max-width: 100%; border-radius: 8px; }
      .container { padding: 0; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); max-width: 100%; width: 95%; margin: 0 auto; }
      .modal-content { padding: 20px 15px; width: 95%; }
      
      /* PERBAIKAN: Spotify pindah ke Kiri di Mobile */
      #spotifyPlayerContainer, #toggleButton { bottom: 10px; left: 10px; right: auto; }
      
      #menfessButton { bottom: 70px; right: 10px; width: 45px; height: 45px; }
      /* Posisi Tombol Upload Story di Mobile */
      #addStoryButton { bottom: 130px; right: 10px; width: 45px; height: 45px; }
      
      /* Mobile Story Fixes */
      .stories-container { width: 95%; justify-content: flex-start; }
      .story-text-display { font-size: 1.2rem; width: 95%; }
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

</head>
<body>
  
  <button id="toggleButton" aria-label="Buka/Tutup Spotify Player"><i class="fab fa-spotify"></i></button>
  <div id="spotifyPlayerContainer">
      <iframe id="spotifyIframe" style="border-radius:12px; transition: box-shadow 0.4s;" src="" width="300" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
  </div>
  <button id="menfessButton" aria-label="Tulis Menfess Baru"><i class="fas fa-paper-plane"></i></button>
  
  <button id="addStoryButton" aria-label="Buat Story Baru" onclick="openAddStoryModal()">
      <i class="fas fa-camera"></i>
  </button>

  <a href="https://xcerdas1.vercel.app/" class="nav-link-left">Home / Beranda</a>
  <a href="prestasi.html" class="nav-link-right">Prestasi Kelas üèÜ</a>

  <h1>UNCLAIRONE STUDENTS</h1>

  <div class="stories-container" id="storiesContainer">
      </div>
  
  <div class="quote-box">
      <div class="quote-icon"><i class="fas fa-quote-left"></i></div>
      <p id="dailyQuote" class="quote-text">Loading quote...</p>
      <p id="dailyAuthor" class="quote-author"></p>
  </div>

  <div class="running-quotes-wrapper">
      <div class="running-track" id="studentQuotesTrack"></div>
  </div>

  <div class="stats-container">
    <div class="stat-box">
        <i class="fas fa-users"></i>
        <span id="statTotalStudents" class="stat-value">36</span>
        <span class="stat-label">Total Siswa</span>
    </div>
    <div class="stat-box">
        <i class="fas fa-birthday-cake"></i>
        <span id="statBirthdayMonth" class="stat-value">0</span>
        <span class="stat-label">Ultah Bulan Ini</span>
    </div>
    <div class="stat-box">
        <i class="fas fa-trophy"></i>
        <span id="statMostOrganization" class="stat-value">Paskibra (6)</span>
        <span class="stat-label">Org. Terbanyak</span>
    </div>
  </div>

  <div class="filter-controls">
      <div class="search-container">
          <input type="text" id="searchInput" onkeyup="filterStudents()" placeholder="Cari nama siswa..." aria-label="Cari nama siswa">
          <div class="search-button-area"><i class="fas fa-search"></i></div>
      </div>
  </div>

  <div class="container" id="studentContainer"></div>
  
  <div id="menfessSection">
    <h2>Pesan Rahasia Kelas (Menfess)</h2>
    <div id="menfessGrid" class="menfess-grid">
        <p style="text-align: center; color: #bdb6f0; width: 100%; grid-column: 1 / -1;">Memuat menfess...</p>
    </div>
  </div>

  <div id="storyViewer" class="story-viewer">
      <div class="story-progress-bar" id="progressBarContainer"></div>
      <span class="story-close-btn" onclick="closeStoryViewer()">√ó</span>
      <div class="story-header">
          <img id="svPhoto" src="" alt="">
          <div>
              <span id="svName">Nama Siswa</span>
              <span id="svTime" class="story-date">2j</span>
          </div>
      </div>
      <div class="story-content-area" onclick="nextStorySegment()">
          <img id="svImage" class="story-image-display" style="display:none;" src="">
          <video id="svVideo" class="story-image-display" style="display:none;" playsinline webkit-playsinline></video>
          <div id="svText" class="story-text-display" style="display:none;"></div>
      </div>
  </div>

  <div id="igUploadOverlay">
      <input type="file" id="igHiddenFileInput" accept="image/*,video/*" style="display: none;" onchange="handleFileSelect(this)">

      <div class="ig-top-bar">
          <div class="ig-user-pill" onclick="toggleIgUserList()">
              <img id="igActiveUserThumb" src="https://via.placeholder.com/50" class="ig-user-thumb">
              <span id="igActiveUserName" class="ig-user-name">Pilih Namamu</span>
              <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 0.8rem;"></i>
          </div>
          <div class="ig-close" onclick="closeIgModal()">√ó</div>
          
          <div id="igUserListDropdown" class="ig-user-list-modal">
              </div>
      </div>

      <div class="ig-preview-stage" id="igPreviewStage">
          <img id="igImgPreview" class="ig-media-preview">
          <video id="igVidPreview" class="ig-media-preview" playsinline loop muted></video>
          
          <textarea id="igCaption" class="ig-caption-input" rows="2" placeholder="Ketik sesuatu..."></textarea>
      </div>

      <div class="ig-bottom-bar">
          <div class="ig-mode-switch">
              <div class="ig-mode-item active" id="modeTextBtn" onclick="setIgMode('text')">Aa Teks</div>
              <div class="ig-mode-item" id="modeMediaBtn" onclick="triggerFileSelect()">Galeri</div>
          </div>
          <button class="ig-send-btn" id="igPostBtn" onclick="postIgStory()">
              Kirim <i class="fas fa-paper-plane"></i>
          </button>
      </div>
  </div>

  <div id="studentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeStudentModal()">√ó</span>
      <div class="modal-header">
        <img id="modalPhoto" class="modal-photo" src="" alt="" title="" /> 
        <h2 id="modalName" class="modal-name"></h2>
      </div>
      <div class="modal-details">
        <p><span class="label">Umur:</span> <span id="modalAge"></span> tahun</p>
        <p><span class="label">Hobi:</span> <span id="modalHobby"></span></p>
        <p><span class="label">Instagram:</span> <a id="modalInstagramLink" href="#" target="_blank" class="instagram-link">@<span id="modalInstagramHandle"></span></a></p>
        <p><span class="label">Agama:</span> <span id="modalReligion"></span></p>
        <p><span class="label">Organisasi:</span> <span id="modalOrganization"></span></p>
      </div>
      <div class="interaction-section">
          <div class="like-container">
              <button id="likeBtn" class="like-btn" onclick="handleLike()"><i class="far fa-heart" id="likeIcon"></i></button>
              <span id="likeCountValue">0</span> Likes
          </div>
          <div class="comments-wrapper">
              <h4>Komentar Teman</h4>
              <div id="commentsList" class="comments-list"><p class="no-comments">Belum ada komentar.</p></div>
              <div class="comment-form">
                  <input type="text" id="commentInput" placeholder="Tulis komentar..." maxlength="150">
                  <button onclick="handleComment()" class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
              </div>
          </div>
      </div>
      <div class="photo-gallery">
          <h3>Galeri Foto Lainnya</h3>
          <div class="gallery-grid" id="modalGallery"></div>
      </div>
    </div>
  </div>

  <div id="birthdayModal" class="modal" style="display: none; z-index: 9999;">
    <div class="modal-content" style="text-align: center; border: 3px solid #ff4359; max-width: 500px;">
        <span class="close-btn" onclick="closeBirthdayModal()">√ó</span>
        <div style="font-size: 4rem; margin-bottom: 10px;">üéâ</div>
        <h2 style="color: #ff775c; font-size: 2rem; margin-bottom: 10px;">Selamat Habede</h2>
        <p style="font-size: 1.2rem;">Selamat habede untuk:</p>
        <div id="birthdayPerson" style="margin: 20px 0; display: flex; flex-direction: column; align-items: center;"></div>
        <p style="color: #bdb6f0;">Semoga panjang umur dan sehat eperitaym</p>
        <button onclick="closeBirthdayModal()" style="margin-top: 20px; padding: 10px 25px; background: #ff4359; color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 1rem;">Aamiin üôè</button>
    </div>
  </div>

  <div id="quoteModal" class="modal" style="z-index: 150;">
    <div class="modal-content quote-modal-content">
        <span class="close-btn" onclick="closeQuoteModal()">√ó</span>
        <div class="quote-modal-icon"><i class="fas fa-quote-left"></i></div>
        <p id="quoteModalText" class="quote-modal-text"></p>
        <div class="quote-modal-author">
            <img id="quoteModalPhoto" src="" alt="">
            <span id="quoteModalName"></span>
        </div>
    </div>
  </div>

  <div id="menfessModal" class="modal" style="z-index: 160;">
    <div class="modal-content menfess-modal-content">
        <span class="close-btn" onclick="closeMenfessModal()">√ó</span>
        <form id="menfessForm" class="menfess-form">
            <h3>Kirim Pesan Rahasia (Menfess)</h3>
            <label for="menfessTo">Kepada Siapa? (Contoh: Akil, All, Admin)</label>
            <input type="text" id="menfessTo" required placeholder="Nama Siswa / All / Lainnya">
            <label for="menfessContent">Isi Pesanmu</label>
            <textarea id="menfessContent" required minlength="10" maxlength="5000" placeholder="Tuliskan menfess-mu di sini (maks. 5000 karakter)"></textarea>
            <label for="menfessFrom">Dari (Opsional)</label>
            <input type="text" id="menfessFrom" placeholder="Nama samaran atau Anonim (default: Anonim)">
            <button type="submit" class="menfess-submit-btn">Kirim Menfess</button>
        </form>
    </div>
  </div>

  <div id="lightbox" class="lightbox">
    <span class="lightbox-close-btn">√ó</span>
    <img class="lightbox-content" id="lightboxImage" alt="" title=""> 
  </div>

  <script>
    // CONFIG FIREBASE
    const firebaseConfig = {
  apiKey: "AIzaSyAnouQgMTahiA0R3pyKb6n_qHYFhX4tfgU",
  authDomain: "website-25711.firebaseapp.com",
  databaseURL: "https://website-25711-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "website-25711",
  storageBucket: "website-25711.appspot.com",
  messagingSenderId: "38660762483",
  appId: "1:38660762483:web:8f0fa0be46a2e901ceb306",
  measurementId: "G-6VB4PRBFYV"
    };
const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore();
const storage = firebase.storage(); // <--- Pastikan ini ada

    // DATA SISWA
   const students = [
      {name: "Ainun Mardiansyah", age: 16, hobby: "Gatahu", instagram: "4inunranii_", photo: "image/Ainun.jpg", religion: "Islam", organization: "Inteens", gallery: [], birthDate: "03-13", description: "Najim hotspott 1", quote: "The best way to predict the future is to create it."},
      {name: "Akifa Naila", age: 16, hobby: "Minta hotspot", instagram: "akiipanaila", photo: "image/Naila.jpg", religion: "Islam", organization: "OSIS", gallery: [], birthDate: "05-15", description: "Najim hotspot 2", quote: "Every moment is a fresh beginning."},
      {name: "Akil Maula S", age: 16, hobby: "Mancing", instagram: "kikiuuuz", photo: "image/Akil.jpg", religion: "Islam", organization: "SEGA", gallery: [], birthDate: "12-31", description: "Starboy, Cool, Jenius, Proplayer epep", quote: "Know yourself, and be the best of yourself."},
      {name: "Amirah Zafirah", age: 15, hobby: "Yapping", instagram: "amirahpspra", photo: "image/Amirah.jpg", religion: "Islam", organization: "Paskibra", gallery: [], birthDate: "03-22", description: "Duta Yapping", quote: "Appreciate every process, because everything has its time."},
      {name: "Andi Naurah", age: 16, hobby: "Nonton Windah", instagram: "nauurahkhalilah", photo: "image/Naura.jpg", religion: "Islam", organization: "KITS/Sega/Sanggar Seni", gallery: [], birthDate: "04-22", description: "pendek", quote: "What are you so afraid of losing when nothing in this world belongs to you."},
      {name: "Anindya Ainun", age: 15, hobby: "gatau", instagram: "_anindyainun", photo: "image/Ainun purba.jpg", religion: "Islam", organization: "Smansa Voice", gallery: [], birthDate: "03-15", description: "tida mau diambil aibnya", quote: "Love the life you live, live the life you love."},
      {name: "Annisa Maylafaiza", age: 16, hobby: "Minta Hotspots", instagram: "annisamaylaa_", photo: "image/Anisa.jpg", religion: "Islam", organization: "Sanggar Seni", gallery: [], birthDate: "05-05", description: "Najim hotspot 3", quote: "Dont be afraid to try, because every small step brings you closer to your goal"},
      {name: "Aprilia Hastikasari", age: 16, hobby: "Bebeng", instagram: "liaaahyy", photo: "image/April.jpg", religion: "Islam", organization: "Pramuka", gallery: [], birthDate: "04-29", description: "Intropet", quote: "Every day is an opportunity to be the best version of yourself."},
      {name: "Clarinta Amabel", age: 15, hobby: "Gemar Makan Batagor", instagram: "claebell", photo: "image/Aring.jpeg", religion: "Protestan", organization: "KITS/Inteens/Sega/PPKS", gallery: [], birthDate: "03-29", description: "Najim hotspot 4", quote: "The future is not waited for, but is shaped from today."},
      {name: "Dhia Syarafana", age: 16, hobby: "Slowmotion", instagram: "syeradelrey", photo: "image/Dhia.jpg", religion: "Islam", organization: "Tidak Ada", gallery: [], birthDate: "06-06", description: "Mati aja ni orang", quote: "Follow your dreams, not your boyfriends."},
      {name: "Fitri", age: 15, hobby: "yapping", instagram: "ffitri1_", photo: "image/Titi.jpg", religion: "Islam", organization: "Tidak Ada", gallery: [], birthDate: "01-11", description: "Gengster", quote: "Life is a journey, Enjoy the ride."},
      {name: "Hodia", age: 16, hobby: "Nonton Windah", instagram: "odiaa_a", photo: "image/Odi.jpg", religion: "Protestan", organization: "Sega/OSIS/Inteens", gallery: [], birthDate: "08-26", description: "Kakram Lovers", quote: "ùëÜùëùùëíùëéùëò ùëôùëíùë†ùë†, ùíçùíäùíîùíïùíÜùíè ùíéùíêùíìùíÜ. ùëÖùëíùëéùëêùë° ùëôùëíùë†ùë†, ùíêùíÉùíîùíÜùíìùíóùíÜ ùíéùíêùíìùíÜ."},
      {name: "Husnul Khatimah", age: 16, hobby: "Main sama Rasya", instagram: "hsnllkhtmh__", photo: "image/Husnul.jpg", religion: "Islam", organization: "Pramuka", gallery: [], birthDate: "03-17", description: "Misterius", quote: "..."},
      {name: "Miftahul", age: 16, hobby: "Minta Hotspot", instagram: "miftahuljannah1507_", photo: "image/Mita.jpg", religion: "Islam", organization: "Paskibra", gallery: [], birthDate: "07-15", description: "Najim hotspot 5", quote: "Learning is the key to opening the door to succes, make every lesson an opportunity to grow and develop."},
      {name: "Fathur Jibriel", age: 15, hobby: "Basket", instagram: "ndadapateuy", photo: "image/patur.jpg", religion: "Islam", organization: "Basket", gallery: [], birthDate: "", description: "Proplayer emel", quote: "Learn from the past, live in the present, and plan for the future"},
      {name: "Muh.Ibrahim", age: 15, hobby: "Takraw", instagram: "ibe_6610", photo: "image/Ibe.jpg", religion: "Islam", organization: "Paskibra", gallery: [], birthDate: "", description: "Pengganggu mati aja", quote: "Believe in yourself."}, 
      {name: "Muh.Tsaqiff", age: 15, hobby: "Main epep", instagram: "muhtsaqiffal", photo: "image/Tsaqif.jpg", religion: "Islam", organization: "Smansa Voice", gallery: [], birthDate: "", description: "Kul, Proplayer epep", quote: "Don't give up, keep fighting"},
      {name: "Muh.Alif Falah Jordan", age: 15, hobby: "Basket", instagram: "_alipjrdan", photo: "image/Alip.jpg", religion: "Islam", organization: "Basket", gallery: [], birthDate: "", description: "Pro player basket. Sering dipanggil Alip Jordang.", quote: "No pain, no gain."},
      {name: "Muh.Faiz Aswin", age: 15, hobby: "Bewan sama Akil", instagram: "mhmmdfaizz28", photo: "image/Faiz.jpg", religion: "Islam", organization: "Tidak Ada", gallery: [], birthDate: "02-28", description: "Cool, Tampan, Berwibawa, Gantenk, Rival Akil", quote: "There is always a way for those who want to try."},
      {name: "Kink Muflih", age: 15, hobby: "Nonton Anime", instagram: "muflih_zaky", photo: "image/Mupli.jpg", religion: "Islam", organization: "Tidak Ada", gallery: [], birthDate: "", description: "Rapper, Coach ML", quote: "It is obligatory to be good in the eyes of God, it is not necessary to look good in the eyes of humans."},
      {name: "M.Raihaan", age: 15, hobby: "Topup Dm", instagram: "rhnzki_16", photo: "image/Rehan.jpg", religion: "Islam", organization: "Putra Putri Smansa", gallery: [], birthDate: "", description: "Multiteleng", quote: "Character is formed in the stormy waves of the world."},
      {name: "Nagym", age: 15, hobby: "Tidur", instagram: "nagymm_", photo: "image/Nagym.jpg", religion: "Islam", organization: "KITS", gallery: [], birthDate: "06-23", description: "Tidur adalah koentji'.", quote: "Be Yourself And Never Surrender."},
      {name: "Naufal Qawwiy", age: 15, hobby: "Tektok Gn", instagram: "naufalqawiyy", photo: "image/nopal.jpg", religion: "Islam", organization: "Wasipalah", gallery: [], birthDate: "04-23", description: "Setarboy, Multiteleng, Jenius, Anak Gunung", quote: "Believe you can and you're halfway there."},
      {name: "Nur Nadya Afifah", age: 16, hobby: "Mengaji", instagram: "dyaafifah_", photo: "image/Afifah.jpg", religion: "Islam", organization: "Komunitas Pelajar Muslim", gallery: [], birthDate: "", description: "Misterius", quote: "Succes doesn't belong to smart people, succes belongs those who always try"},
      {name: "Nurfadillah Quinsya", age: 16, hobby: "nntndramaeverytaym", instagram: "nurfdilhqsya_", photo: "image/Nyonyo.jpg", religion: "Islam", organization: "Sanggar Seni", gallery: [], birthDate: "", description: "Kenalin ini Nyonyok", quote: "Always be grateful, and keep trying to be better."},
      {name: "Qonitha Cleonima", age: 16, hobby: "Silat", instagram: "qoniitataa", photo: "image/Qoni.jpeg", religion: "Islam", organization: "Paskibra", gallery: [], birthDate: "", description: "Jago bela diri Silat, jangan macam-macam dengannya! anjay", quote: "Don't say you can't before you try."},
      {name: "Rafailah Andini", age: 16, hobby: "Nda tau", instagram: "rafailahandini", photo: "image/dini.jpg", religion: "Islam", organization: "OSIS/PMR", gallery: [], birthDate: "04-02", description: "Misterius", quote: "Brains, beauty, and books."},
      {name: "Raihanah Nadira", age: 16, hobby: "Nonton yutub", instagram: "raihanadiraa", photo: "image/Reihana.jpeg", religion: "Islam", organization: "Sega/Sanggar Seni", gallery: [], birthDate: "", description: "Misterius", quote: "Character is formed in the stormy waves of the world."},
      {name: "Rasya Az'Zahra", age: 16, hobby: "Basket", instagram: "rasya_azzahra", photo: "image/Rasyaa.jpg", religion: "Islam", organization: "Basket", gallery: [], birthDate: "", description: "Misterius", quote: "..."},
      {name: "Aulia", age: 16, hobby: "Menggambar", instagram: "auliaaa_dn", photo: "image/Aul.jpg", religion: "Islam", organization: "Paskibra", gallery: [], birthDate: "", description: "Misterius", quote: "Believe in yourself."},
      {name: "ACOK NI BOS", age: 15, hobby: "anu", instagram: "rrezxkyy30", photo: "image/Aco.jpeg", religion: "Islam", organization: "OSIS/Paskibra", gallery: [], birthDate: "01-30", description: "Cool, Keren, Gantenk, Beraura, Baik, Positip vibes, GrinFleg", quote: "Don't plan too much, some of the most beatiful moments in our lives are actually unplanned."},
      {name: "Syifa BTR", age: 16, hobby: "nda tau", instagram: "syfabhtr_", photo: "image/Cipa.jpg", religion: "Islam", organization: "KITS/Inteens/Sanggar/PPS", gallery: [], birthDate: "09-09", description: "#Bata Out", quote: "Always breathe until you die."},
      {name: "Vanezia", age: 15, hobby: "Menari", instagram: "vvsloav_19", photo: "https://randomuser.me/api/portraits/men/33.jpg", religion: "Islam", organization: "Sanggar Seni", gallery: [], birthDate: "", description: "Pendek", quote: "There is no such thing as failure in this life, except when you give up when facing trials."},
      {name: "Wilyam", age: 15, hobby: "pegang konde", instagram: "ultraawill", photo: "image/Wilyam.jpg", religion: "Katolik", organization: "Smansa Voice", gallery: [], birthDate: "", description: "Hati-hati dengannya lengah dikit pegang konde", quote: "Stay cool, for sure"},
      {name: "Zahra Mauaja", age: 16, hobby: "Apa yak", instagram: "zhrmdkyya", photo: "image/Yayaa.jpg", religion: "Islam", organization: "Tahfidz", gallery: [], birthDate: "", description: "Zahra mau aja", quote: "Dame ungger? Ungkeh."},
      {name: "Zyqri Al Farezqhi", age: 15, hobby: "main roblox", instagram: "zyqrialfarezqhi18", photo: "image/Zyqri.jpg", religion: "Islam", organization: "KITS/PMR", gallery: [], birthDate: "01-18", description: "Teman Teka Nagym", quote: "Better to fail trying than to regret for doing nothing."},
    ];
    
    // Elemen DOM
    const container = document.getElementById('studentContainer');
    const modal = document.getElementById('studentModal');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImage');
    const lightboxCloseBtn = document.querySelector('.lightbox-close-btn');
    const viewportMeta = document.getElementById('viewportMeta');
    const DEFAULT_META = "width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no";
    const ZOOMABLE_META = "width=device-width, initial-scale=1, user-scalable=yes"; 
    let currentGalleryPhotos = []; 
    let currentPhotoIndex = 0;    

    // --- Lightbox Logic ---
    function openLightBox(src, photos, index) {
        viewportMeta.content = ZOOMABLE_META; currentGalleryPhotos = photos; currentPhotoIndex = index;
        lightboxImg.src = src; lightbox.style.display = 'flex'; updateLightboxNav(); 
    }
    function closeLightBox() {
        viewportMeta.content = DEFAULT_META; lightbox.style.display = 'none';
    }
    function updateLightboxNav() {
        let prevBtn = document.getElementById('lightboxPrevBtn');
        let nextBtn = document.getElementById('lightboxNextBtn');
        if (!prevBtn) {
            prevBtn = document.createElement('span'); prevBtn.id = 'lightboxPrevBtn'; prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>'; 
            prevBtn.classList.add('lightbox-nav-btn', 'prev'); prevBtn.onclick = (e) => { e.stopPropagation(); changePhoto(-1); };
            lightbox.appendChild(prevBtn);
            nextBtn = document.createElement('span'); nextBtn.id = 'lightboxNextBtn'; nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>'; 
            nextBtn.classList.add('lightbox-nav-btn', 'next'); nextBtn.onclick = (e) => { e.stopPropagation(); changePhoto(1); };
            lightbox.appendChild(nextBtn);
        }
        if (currentGalleryPhotos.length <= 1) { prevBtn.style.display = 'none'; nextBtn.style.display = 'none'; return; }
        prevBtn.style.display = 'flex'; nextBtn.style.display = 'flex';
        prevBtn.style.visibility = (currentPhotoIndex === 0) ? 'hidden' : 'visible';
        nextBtn.style.visibility = (currentPhotoIndex === currentGalleryPhotos.length - 1) ? 'hidden' : 'visible';
    }
    function changePhoto(n) {
        let newIndex = currentPhotoIndex + n;
        if (newIndex >= 0 && newIndex < currentGalleryPhotos.length) {
            currentPhotoIndex = newIndex; lightboxImg.style.opacity = 0; 
            setTimeout(() => { lightboxImg.src = currentGalleryPhotos[currentPhotoIndex]; lightboxImg.style.opacity = 1; updateLightboxNav(); }, 150); 
        }
    }

    // --- Stats Logic ---
    function calculateAndDisplayStats() {
        const totalStudents = students.length; const today = new Date(); const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
        let birthdayCount = 0; const organizationCounts = {};
        students.forEach(s => {
            if (s.birthDate && s.birthDate.length >= 5 && s.birthDate.substring(0, 2) === currentMonth) { birthdayCount++; }
            const orgs = s.organization.split('/').map(o => o.trim()).filter(o => o !== 'Tidak Ada' && o !== 'gatau' && o !== '');
            orgs.forEach(org => { organizationCounts[org] = (organizationCounts[org] || 0) + 1; });
        });
        let mostPopularOrg = 'Belum Ada Data'; let maxCount = 0; let tiedOrgs = [];
        for (const org in organizationCounts) {
            if (organizationCounts[org] > maxCount) { maxCount = organizationCounts[org]; mostPopularOrg = org; tiedOrgs = [org]; } 
            else if (organizationCounts[org] === maxCount && maxCount > 0) { tiedOrgs.push(org); }
        }
        let orgDisplay = (maxCount > 0) ? (tiedOrgs.length > 1 ? `${tiedOrgs[0]} & Lainnya` : mostPopularOrg) : mostPopularOrg;
        document.getElementById('statTotalStudents').textContent = totalStudents;
        document.getElementById('statBirthdayMonth').textContent = birthdayCount;
        document.getElementById('statMostOrganization').textContent = `${orgDisplay} (${maxCount})`;
    }

    // --- Search Logic ---
    function filterStudents() {
        const input = document.getElementById('searchInput'); const filterText = input.value.toUpperCase();
        const cards = container.getElementsByClassName('card');
        for (let i = 0; i < cards.length; i++) {
            const card = cards[i]; const nameElement = card.querySelector('.name');
            const name = nameElement.textContent || nameElement.innerText;
            card.style.display = (name.toUpperCase().indexOf(filterText) > -1) ? "" : "none";
        }
    }

    // --- Like & Comment Logic ---
    let currentStudentName = ""; let interactionListener = null; 
    function initGlobalLikeListener() {
        db.collection('student_interactions').onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const docId = change.doc.id; const data = change.doc.data(); const likes = data.likes || 0;
                const card = document.querySelector(`.card[data-name="${docId.replace(/"/g, '\\"')}"]`);
                if (card) { const badgeValue = card.querySelector('.card-like-value'); if (badgeValue) badgeValue.textContent = likes; }
            });
        });
    }
    function loadInteractions(name) {
        currentStudentName = name; const likeBtn = document.getElementById('likeBtn'); const likeIcon = document.getElementById('likeIcon');
        const likeCountVal = document.getElementById('likeCountValue'); const commentsList = document.getElementById('commentsList');
        likeCountVal.textContent = "..."; commentsList.innerHTML = '<p class="no-comments">Memuat...</p>'; document.getElementById('commentInput').value = "";
        const hasLiked = localStorage.getItem(`liked_${currentStudentName}`);
        if (hasLiked) { likeBtn.classList.add('liked'); likeIcon.className = 'fas fa-heart'; } else { likeBtn.classList.remove('liked'); likeIcon.className = 'far fa-heart'; }
        if (interactionListener) interactionListener(); 
        interactionListener = db.collection('student_interactions').doc(currentStudentName).onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data(); likeCountVal.textContent = data.likes || 0; const comments = data.comments || [];
                if (comments.length === 0) { commentsList.innerHTML = '<p class="no-comments">Belum ada komentar. Jadilah yang pertama!</p>'; } 
                else {
                    commentsList.innerHTML = '';
                    comments.reverse().forEach(c => {
                        const div = document.createElement('div'); div.className = 'comment-item';
                        let timeStr = c.timestamp && c.timestamp.toDate ? c.timestamp.toDate().toLocaleDateString('id-ID') + " " + c.timestamp.toDate().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) : "";
                        div.innerHTML = `<div class="comment-header"><span>${c.user}</span><span style="font-weight:normal; opacity:0.7;">${timeStr}</span></div><div class="comment-text">${c.text}</div>`;
                        commentsList.appendChild(div);
                    });
                }
            } else { likeCountVal.textContent = 0; commentsList.innerHTML = '<p class="no-comments">Belum ada komentar.</p>'; }
        });
    }
    function handleLike() {
        if (!currentStudentName) return; const docRef = db.collection('student_interactions').doc(currentStudentName);
        const isLiked = localStorage.getItem(`liked_${currentStudentName}`);
        if (isLiked) {
            docRef.set({ likes: firebase.firestore.FieldValue.increment(-1) }, { merge: true });
            localStorage.removeItem(`liked_${currentStudentName}`);
            document.getElementById('likeBtn').classList.remove('liked'); document.getElementById('likeIcon').className = 'far fa-heart';
        } else {
            docRef.set({ likes: firebase.firestore.FieldValue.increment(1) }, { merge: true }); 
            localStorage.setItem(`liked_${currentStudentName}`, "true");
            document.getElementById('likeBtn').classList.add('liked'); document.getElementById('likeIcon').className = 'fas fa-heart';
        }
    }
    function handleComment() {
        if (!currentStudentName) return; const input = document.getElementById('commentInput'); const text = input.value.trim();
        if (text.length < 2) { alert("Komentar terlalu pendek!"); return; }
        db.collection('student_interactions').doc(currentStudentName).set({
            comments: firebase.firestore.FieldValue.arrayUnion({ user: "Anonim", text: text, timestamp: new Date() })
        }, { merge: true }).then(() => { input.value = ""; document.getElementById('commentsList').scrollTop = 0; })
        .catch((error) => { console.error("Error adding comment: ", error); alert("Gagal mengirim komentar."); });
    }

    // --- Show Detail Logic ---
    async function showStudentDetails(student) {
        document.getElementById('modalPhoto').src = student.photo; document.getElementById('modalName').textContent = student.name;
        document.getElementById('modalAge').textContent = student.age; document.getElementById('modalHobby').textContent = student.hobby;
        let religion = student.religion || 'Tidak Diketahui'; if (religion.includes('Prot  estan')) religion = 'Protestan';
        document.getElementById('modalReligion').textContent = religion; document.getElementById('modalOrganization').textContent = student.organization || 'Tidak Diketahui';
        document.getElementById('modalInstagramLink').href = `https://instagram.com/${student.instagram}`;
        document.getElementById('modalInstagramHandle').textContent = student.instagram;
        const galleryGrid = document.getElementById('modalGallery'); galleryGrid.innerHTML = 'Loading Gallery...'; 
        let galleryPhotos = student.gallery && student.gallery.length > 0 ? student.gallery : [student.photo]; 
        try {
            const snapshot = await db.collection('studentsGallery').where('name', '==', student.name).limit(1).get();
            if (!snapshot.empty) { const d = snapshot.docs[0].data(); if (d.galleryPhotos && d.galleryPhotos.length > 0) galleryPhotos = d.galleryPhotos; }
        } catch (e) { console.error(e); }
        galleryGrid.innerHTML = '';
        galleryPhotos.forEach((url, index) => {
            const img = document.createElement('img'); img.className = 'gallery-img'; img.src = url;
            img.addEventListener('click', (e) => { e.stopPropagation(); openLightBox(url, galleryPhotos, index); });
            galleryGrid.appendChild(img);
        });
        loadInteractions(student.name); modal.style.display = 'flex'; 
    }

    // --- Render Cards ---
    students.forEach((s, index) => {
      const card = document.createElement('div'); card.className = 'card';
      card.setAttribute('data-index', index); card.setAttribute('data-name', s.name); 
      card.setAttribute('data-tilt', ''); card.setAttribute('data-tilt-glare', ''); card.setAttribute('data-tilt-max-glare', '0.3'); card.setAttribute('data-tilt-scale', '1.05'); 
      card.innerHTML = `
        <div class="card-like-badge"><i class="fas fa-heart"></i> <span class="card-like-value">0</span></div>
        <img class="photo" src="${s.photo}" alt="Foto ${s.name}" />
        <div class="name">${s.name}</div>
        <div class="info"><span class="label">Umur:</span> ${s.age} tahun</div>
        <div class="info"><span class="label">Hobi:</span> ${s.hobby}</div>
        <div class="description">${s.description || 'Deskripsi belum diisi.'}</div> 
        <div class="info"><span class="label ig-label">Instagram:</span> <a href="https://instagram.com/${s.instagram}" target="_blank" class="instagram-link">@${s.instagram}</a></div>
      `;
      card.addEventListener('click', () => { showStudentDetails(students[index]); });
      container.appendChild(card); VanillaTilt.init(card);
      setTimeout(() => { card.classList.add('animate'); }, index * 100);
    });

    // --- Close Modals ---
    function closeStudentModal() { modal.style.display = 'none'; if (interactionListener) { interactionListener(); interactionListener = null; } }
    lightboxCloseBtn.onclick = function() { closeLightBox(); }
    window.onclick = function(event) {
      if (event.target == modal) closeStudentModal();
      if (event.target == lightbox) closeLightBox();
      if (event.target == document.getElementById('quoteModal')) closeQuoteModal();
      if (event.target == document.getElementById('menfessModal')) closeMenfessModal();
    }

    // --- Swipe/Nav Logic ---
    window.addEventListener('keydown', function(e) { if (lightbox.style.display === 'flex') { if (e.key === 'ArrowLeft') changePhoto(-1); else if (e.key === 'ArrowRight') changePhoto(1); } });
    let touchstartX = 0; let touchendX = 0;
    lightboxImg.addEventListener('touchstart', function(event) { if (event.touches.length === 1) touchstartX = event.touches[0].screenX; }, false);
    lightboxImg.addEventListener('touchend', function(event) { if (lightbox.style.display === 'flex') { touchendX = event.changedTouches[0].screenX; if (touchendX < touchstartX - 50) changePhoto(1); if (touchendX > touchstartX + 50) changePhoto(-1); } }, false);
    
    // --- Birthday Logic ---
    function checkBirthday() {
        const today = new Date(); const todayString = String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0');
        const birthdayStudents = students.filter(s => s.birthDate && s.birthDate.startsWith(todayString));
        if (birthdayStudents.length > 0) {
            const containerUltah = document.getElementById('birthdayPerson'); containerUltah.innerHTML = '';
            birthdayStudents.forEach(s => {
                const div = document.createElement('div');
                div.innerHTML = `<img src="${s.photo}" style="width:120px;height:120px;border-radius:50%;border:4px solid #ff4359;object-fit:cover;margin-bottom:10px;"><h3 style="color:#ffffff;margin:0;">${s.name}</h3>`;
                containerUltah.appendChild(div);
            });
            document.getElementById('birthdayModal').style.display = 'flex'; fireConfetti();
        }
    } 
    function closeBirthdayModal() { document.getElementById('birthdayModal').style.display = 'none'; }
    function fireConfetti() {
        var duration = 3000; var end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    // --- Quotes Logic ---
    const quotesCollection = [
        { text: "Sekolah itu tempat menuntut ilmu, bukan menuntut dia peka.", author: "Anonim" },
        { text: "janganlah kamu menjadi seperti ekspektasi seseorang tapi bertindaklah seperti keinginanmu", author: "KINK MUPLI" },
        { text: "Berdansalah, Karir Ini Tak Ada Artinya.", author: "Hindia" },
        { text: "Kami sebenarnya bisa, cuma males aja", author: "Ibe" },
        { text: "Jadilah versi terbaik dari dirimu sendiri.", author: "Motivasi" }
    ];
    function displayDailyQuote() {
        const index = new Date().getDate() % quotesCollection.length;
        document.getElementById('dailyQuote').textContent = `"${quotesCollection[index].text}"`;
        document.getElementById('dailyAuthor').textContent = `- ${quotesCollection[index].author}`;
    }
    function renderStudentQuotes() {
        const track = document.getElementById('studentQuotesTrack'); if (!track) return;
        const activeStudentsData = students.map((s, i) => ({...s, i})).filter(s => s.quote && s.quote.length > 2);
        track.innerHTML = activeStudentsData.map(s => `
            <div class="student-quote-card" onclick="openQuoteModal(${s.i})">
                <div class="sq-text">"${s.quote}"</div>
                <div class="sq-author"><img src="${s.photo}"> ${s.name.split(' ')[0]}</div>
            </div>`).join('');
    }
    function openQuoteModal(index) {
        if (clickBlocked) { clickBlocked = false; return; } 
        const s = students[index]; document.getElementById('quoteModalText').textContent = `"${s.quote}"`;
        document.getElementById('quoteModalName').textContent = s.name; document.getElementById('quoteModalPhoto').src = s.photo;
        document.getElementById('quoteModal').style.display = 'flex';
    }
    function closeQuoteModal() { document.getElementById('quoteModal').style.display = 'none'; }

    // --- Scroll Logic ---
    const scrollWrapper = document.querySelector('.running-quotes-wrapper');
    let scrollInterval; let isDragging = false; let clickBlocked = false; let startX; let scrollLeft; let startPageX; 
    function startAutoScroll() {
        if (!scrollWrapper) return; if (scrollInterval) clearInterval(scrollInterval);
        scrollInterval = setInterval(() => {
            if (isDragging) return; scrollWrapper.scrollLeft += 0.5; 
            if (scrollWrapper.scrollLeft + scrollWrapper.clientWidth >= scrollWrapper.scrollWidth - 1) scrollWrapper.scrollLeft = 0; 
        }, 10);
    }
    if (scrollWrapper) {
        scrollWrapper.addEventListener('mousedown', (e) => { isDragging = true; clickBlocked = false; scrollWrapper.classList.add('active-drag'); clearInterval(scrollInterval); startX = e.pageX - scrollWrapper.offsetLeft; startPageX = e.pageX; scrollLeft = scrollWrapper.scrollLeft; });
        scrollWrapper.addEventListener('touchstart', (e) => { isDragging = true; clickBlocked = false; scrollWrapper.classList.add('active-drag'); clearInterval(scrollInterval); startX = e.touches[0].pageX - scrollWrapper.offsetLeft; startPageX = e.touches[0].pageX; scrollLeft = scrollWrapper.scrollLeft; }, {passive:true});
        window.addEventListener('mousemove', (e) => { if(!isDragging) return; e.preventDefault(); const x = e.pageX - scrollWrapper.offsetLeft; scrollWrapper.scrollLeft = scrollLeft - (x - startX) * 1.5; if(Math.abs(e.pageX - startPageX)>5) clickBlocked=true; });
        window.addEventListener('touchmove', (e) => { if(!isDragging) return; const x = e.touches[0].pageX - scrollWrapper.offsetLeft; scrollWrapper.scrollLeft = scrollLeft - (x - startX) * 1.5; if(Math.abs(e.touches[0].pageX - startPageX)>5) clickBlocked=true; });
        window.addEventListener('mouseup', () => { isDragging = false; scrollWrapper.classList.remove('active-drag'); setTimeout(startAutoScroll, 500); });
        window.addEventListener('touchend', () => { isDragging = false; scrollWrapper.classList.remove('active-drag'); setTimeout(startAutoScroll, 500); });
    }

    // --- Spotify Logic ---
    const spotifyIframe = document.getElementById('spotifyIframe'); const playerContainer = document.getElementById('spotifyPlayerContainer'); const toggleButton = document.getElementById('toggleButton');
    const trackIds = ['1Q7EgiMOuwDcB0PJC6AzON', '5TTGoX70AFrTvuEtqHK37S', '0mQRgmkyY3S2rtiLVzbhHj', '62thhXr3NIiZrn0xbBHaZo'];
    function loadRandomSpotifyTrack() {
        if (!spotifyIframe) return; const randomTrackId = trackIds[Math.floor(Math.random() * trackIds.length)];
        spotifyIframe.src = `https://open.spotify.com/embed/track/${randomTrackId}?utm_source=generator&theme=0&compact=1`;
    }
    if (toggleButton) toggleButton.addEventListener('click', () => {
        playerContainer.classList.toggle('open');
        toggleButton.querySelector('i').className = playerContainer.classList.contains('open') ? 'fas fa-chevron-down' : 'fab fa-spotify';
    });

    // --- Menfess Logic ---
    function openMenfessModal() { document.getElementById('menfessModal').style.display = 'flex'; }
    function closeMenfessModal() { document.getElementById('menfessModal').style.display = 'none'; document.getElementById('menfessForm').reset(); }
    async function saveMenfess(e) {
        e.preventDefault();
        const to = document.getElementById('menfessTo').value.trim() || 'All'; const content = document.getElementById('menfessContent').value.trim();
        const from = document.getElementById('menfessFrom').value.trim() || 'Anonim'; const submitBtn = document.querySelector('.menfess-submit-btn');
        if (content.length < 10) { alert('Isi pesan terlalu pendek.'); return; }
        submitBtn.textContent = 'Mengirim...'; submitBtn.disabled = true;
        try {
            await db.collection('menfess').add({ to: to, content: content, from: from, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            alert('Menfess berhasil dikirim!'); closeMenfessModal(); setTimeout(loadMenfess, 1000); 
        } catch (err) { console.error(err); alert("Gagal mengirim."); } finally { submitBtn.textContent = 'Kirim Menfess'; submitBtn.disabled = false; }
    }
    async function loadMenfess() {
        const menfessGrid = document.getElementById('menfessGrid'); if (!menfessGrid) return;
        try {
            const snapshot = await db.collection('menfess').orderBy('timestamp', 'desc').limit(20).get();
            if (snapshot.empty) { menfessGrid.innerHTML = '<p style="text-align:center;color:#bdb6f0;width:100%;">Belum ada pesan.</p>'; return; }
            menfessGrid.innerHTML = snapshot.docs.map(doc => {
                const d = doc.data(); const date = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate().toLocaleDateString('id-ID') : 'Baru Saja';
                return `<div class="menfess-card"><div class="menfess-to">Untuk: ${d.to}</div><div class="menfess-content">${d.content}</div><div class="menfess-footer"><span class="menfess-from">Dari: ${d.from}</span><span class="menfess-date">${date}</span></div></div>`;
            }).join('');
        } catch (err) { menfessGrid.innerHTML = 'Gagal memuat menfess.'; }
    }

    // ==========================================
    // ** LOGIKA BARU: IG STYLE UPLOAD **
    // ==========================================
    
    let currentIgMode = 'text';
    let selectedStoryFile = null;
    let selectedAuthorData = null;

    function openAddStoryModal() {
        document.getElementById('igUploadOverlay').style.display = 'flex';
        populateIgUserList();
        setIgMode('text'); // Default ke mode teks
    }

    function closeIgModal() {
        document.getElementById('igUploadOverlay').style.display = 'none';
        resetIgForm();
    }

    function resetIgForm() {
        selectedStoryFile = null;
        document.getElementById('igCaption').value = "";
        document.getElementById('igImgPreview').style.display = 'none';
        document.getElementById('igVidPreview').style.display = 'none';
        document.getElementById('igHiddenFileInput').value = "";
        // Jangan reset user agar tidak perlu pilih lagi jika mau post lagi
    }

    function populateIgUserList() {
        const listContainer = document.getElementById('igUserListDropdown');
        listContainer.innerHTML = '';
        
        // Sort siswa abjad
        const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name));

        sortedStudents.forEach(s => {
            const div = document.createElement('div');
            div.className = 'ig-user-option';
            div.innerHTML = `<img src="${s.photo}"><span>${s.name}</span>`;
            div.onclick = () => selectIgUser(s);
            listContainer.appendChild(div);
        });
    }

    function toggleIgUserList() {
        const list = document.getElementById('igUserListDropdown');
        list.style.display = (list.style.display === 'block') ? 'none' : 'block';
    }

    function selectIgUser(student) {
        selectedAuthorData = student;
        document.getElementById('igActiveUserName').textContent = student.name.split(' ')[0]; // Ambil nama depan aja biar muat
        document.getElementById('igActiveUserThumb').src = student.photo;
        document.getElementById('igUserListDropdown').style.display = 'none';
    }

    function setIgMode(mode) {
        currentIgMode = mode;
        const stage = document.getElementById('igPreviewStage');
        const textBtn = document.getElementById('modeTextBtn');
        const mediaBtn = document.getElementById('modeMediaBtn');

        // Reset Preview Media
        document.getElementById('igImgPreview').style.display = 'none';
        document.getElementById('igVidPreview').style.display = 'none';

        if (mode === 'text') {
            textBtn.classList.add('active');
            mediaBtn.classList.remove('active');
            stage.style.background = "linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045)";
            selectedStoryFile = null; // Hapus file jika pindah ke mode text
        } else {
            // Mode Media: background hitam, tunggu file dipilih
            textBtn.classList.remove('active');
            mediaBtn.classList.add('active');
            stage.style.background = "#000";
        }
    }

    function triggerFileSelect() {
        document.getElementById('igHiddenFileInput').click();
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            selectedStoryFile = file;
            
            // Set UI ke Mode Media
            setIgMode('media'); 

            const reader = new FileReader();
            const isVideo = file.type.startsWith('video/');
            
            reader.onload = function(e) {
                if (isVideo) {
                    const vid = document.getElementById('igVidPreview');
                    vid.src = e.target.result;
                    vid.style.display = 'block';
                    vid.play();
                } else {
                    const img = document.getElementById('igImgPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }
    }

    // --- FUNGSI POST STORY ---
    async function postIgStory() {
        if (!selectedAuthorData) {
            alert("Pilih namamu dulu di pojok kiri atas!");
            toggleIgUserList();
            return;
        }

        const caption = document.getElementById('igCaption').value;
        const btn = document.getElementById('igPostBtn');
        
        // Validasi: Harus ada konten (File ATAU Teks)
        if (currentIgMode === 'text' && !caption) {
            alert("Ketik sesuatu dong!");
            return;
        }
        if (currentIgMode === 'media' && !selectedStoryFile) {
            alert("Pilih foto/video dulu!");
            return;
        }

        // Mulai Proses Upload
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
        btn.disabled = true;

        try {
            let finalType = currentIgMode; // 'text' atau 'media'
            let finalContent = caption;

            // Jika ada file, upload dulu
            if (currentIgMode === 'media' && selectedStoryFile) {
                // Tentukan tipe
                if (selectedStoryFile.type.startsWith('image/')) finalType = 'image';
                else if (selectedStoryFile.type.startsWith('video/')) finalType = 'video';

                // Upload ke Storage
                const storageRef = firebase.storage().ref();
                const fileName = `stories/${Date.now()}_${selectedStoryFile.name}`;
                const uploadTask = storageRef.child(fileName).put(selectedStoryFile);

                // Kita pakai Promise agar bisa await
                const snapshot = await uploadTask;
                finalContent = await snapshot.ref.getDownloadURL();
            }

            await db.collection('class_stories').add({
                author: selectedAuthorData.name,
                authorPhoto: selectedAuthorData.photo,
                type: finalType, 
                content: finalContent, // URL Gambar/Video atau Isi Teks
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) 
            });

            // Animasi Confetti kecil
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            
            // Tutup Modal
            closeIgModal();
            alert("Story berhasil diupload!");

        } catch (error) {
            console.error(error);
            alert("Gagal upload: " + error.message);
        } finally {
            btn.innerHTML = 'Kirim <i class="fas fa-paper-plane"></i>';
            btn.disabled = false;
        }
    }

    // --- LOAD & VIEW STORY ---
    let activeStories = {}; 
    function loadStories() {
        const storiesContainer = document.getElementById('storiesContainer');
        db.collection('class_stories')
          .where('expiresAt', '>', new Date())
          .orderBy('expiresAt', 'asc')
          .onSnapshot(snapshot => {
              activeStories = {}; 
              snapshot.docs.forEach(doc => {
                  const data = doc.data();
                  if (!activeStories[data.author]) activeStories[data.author] = [];
                  activeStories[data.author].push(data);
              });
              
              // Clear container (karena tombol upload sudah dipisah)
              storiesContainer.innerHTML = '';

              // Pesan jika kosong
              if (Object.keys(activeStories).length === 0) {
                  storiesContainer.innerHTML = '<span style="color:#bdb6f0; font-size:0.8rem; padding:20px; width:100%; text-align:center; display:block;">Belum ada story. Tekan tombol kamera di bawah!</span>';
              }

              Object.keys(activeStories).forEach(author => {
                  const userStories = activeStories[author]; const lastStory = userStories[userStories.length - 1]; 
                  const div = document.createElement('div'); div.className = 'story-item'; div.onclick = () => viewStory(author);
                  div.innerHTML = `<div class="story-ring"><img src="${lastStory.authorPhoto}" class="story-photo"></div><span class="story-name">${author.split(' ')[0]}</span>`;
                  storiesContainer.appendChild(div);
              });
        });
    }

    let currentStoryQueue = []; 
    let currentStoryIndex = 0; 
    let storyTimer;

    function viewStory(authorName) {
        currentStoryQueue = activeStories[authorName]; 
        currentStoryIndex = 0;
        if (!currentStoryQueue || currentStoryQueue.length === 0) return;
        document.getElementById('storyViewer').style.display = 'flex'; 
        showStorySlide();
    }

    function showStorySlide() {
        clearTimeout(storyTimer); // Reset timer sebelumnya
        
        if (currentStoryIndex >= currentStoryQueue.length) { 
            closeStoryViewer(); 
            return; 
        }

        const data = currentStoryQueue[currentStoryIndex];
        const imgDisplay = document.getElementById('svImage');
        const videoDisplay = document.getElementById('svVideo');
        const textDisplay = document.getElementById('svText');
        
        // Reset Tampilan
        imgDisplay.style.display = 'none';
        videoDisplay.style.display = 'none';
        textDisplay.style.display = 'none';
        
        // Header Info
        document.getElementById('svPhoto').src = data.authorPhoto; 
        document.getElementById('svName').textContent = data.author;
        let timeStr = "Baru saja";
        if (data.timestamp) {
            const diff = new Date() - data.timestamp.toDate();
            const hours = Math.floor(diff / 3600000); 
            const mins = Math.floor(diff / 60000);
            timeStr = hours > 0 ? `${hours}j` : `${mins}m`;
        }
        document.getElementById('svTime').textContent = timeStr;

        // Setup Konten & Durasi
        let duration = 5000; // Default 5 detik untuk teks/foto

        if (data.type === 'image') {
            imgDisplay.style.display = 'block';
            imgDisplay.src = data.content;
        } 
        else if (data.type === 'video') {
            videoDisplay.style.display = 'block';
            videoDisplay.src = data.content;
            videoDisplay.currentTime = 0;
            videoDisplay.muted = false; 
            
            // Tunggu hingga metadata video terload
            videoDisplay.onloadedmetadata = function() {
                let durationMs = videoDisplay.duration * 1000;
                if(isNaN(durationMs) || durationMs < 1000) durationMs = 15000; // Fallback 15 detik jika gagal ambil
                
                // Play video
                videoDisplay.play().catch(e => console.log("Autoplay prevented", e));
                
                // Mulai Progress Bar dengan durasi yang sesuai
                startProgressBar(durationMs); 
                
                // Timer akan otomatis berhenti karena ada onended listener
            };
            
            // Jika video selesai, lanjut next
            videoDisplay.onended = function() {
                nextStorySegment();
            };
            
            // Jika onloadedmetadata terlalu lambat/gagal, tetap set timer default
            storyTimer = setTimeout(() => {
                if(!videoDisplay.paused) nextStorySegment();
            }, 15000); // Batas 15 detik
            
            return; // Penting: Keluar function agar tidak kena timer default di bawah
        } 

        
        else {
            // Teks
            textDisplay.style.display = 'block'; 
            textDisplay.textContent = `"${data.content}"`;
        }

        startProgressBar(duration);
        storyTimer = setTimeout(nextStorySegment, duration);
    }

    function startProgressBar(duration) {
        const pbContainer = document.getElementById('progressBarContainer'); 
        pbContainer.innerHTML = '';
        
        currentStoryQueue.forEach((_, idx) => {
            const seg = document.createElement('div'); seg.className = 'progress-segment';
            const fill = document.createElement('div'); fill.className = 'progress-fill';
            
            if (idx < currentStoryIndex) {
                fill.style.width = '100%';
            } else if (idx === currentStoryIndex) {
                fill.style.width = '0%';
                // Force reflow
                void fill.offsetWidth; 
                fill.style.transition = `width ${duration}ms linear`;
                fill.style.width = '100%';
            } else {
                fill.style.width = '0%';
            }
            seg.appendChild(fill); 
            pbContainer.appendChild(seg);
        });
    }

    function nextStorySegment() { 
        const videoDisplay = document.getElementById('svVideo');
        if(videoDisplay) videoDisplay.pause();
        
        currentStoryIndex++; 
        showStorySlide(); 
    }

    function closeStoryViewer() { 
        document.getElementById('storyViewer').style.display = 'none'; 
        clearTimeout(storyTimer); 
        document.getElementById('svVideo').pause();
        document.getElementById('svVideo').src = "";
    }

    // --- MAIN INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        checkBirthday(); displayDailyQuote(); calculateAndDisplayStats(); 
        renderStudentQuotes(); startAutoScroll(); loadRandomSpotifyTrack();
        initGlobalLikeListener(); loadMenfess(); 
        if (document.getElementById('menfessButton')) document.getElementById('menfessButton').addEventListener('click', openMenfessModal);
        if (document.getElementById('menfessForm')) document.getElementById('menfessForm').addEventListener('submit', saveMenfess);
        
        loadStories(); // Load fitur story
    });
  </script>
</body>
</html>